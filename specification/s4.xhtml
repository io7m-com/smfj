<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>io7m-smfj 0.9.0 Specification: 4. SMFB - Binary Encoding</title><meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8"/><link rel="stylesheet" type="text/css" href="kstructural-layout.css"/><link rel="stylesheet" type="text/css" href="kstructural-colour.css"/><link rel="stylesheet" type="text/css" href="specification.css"/></head><body><div class="st300_body"><div class="st300_navbar st300_navbar_top"><table class="st300_navbar_table" summary="st300_Navigation bar"><tr><td class="st300_navbar_prev_title_cell">3. SMFT - Text Encoding</td><td class="st300_navbar_up_title_cell">io7m-smfj 0.9.0 Specification</td><td class="st300_navbar_next_title_cell"/></tr><tr><td class="st300_navbar_prev_file_cell"><a rel="previous" href="s3.xhtml#st300_s3" title="Go to previous page">Previous</a></td><td class="st300_navbar_up_file_cell"><a rel="up" href="index-m.xhtml" title="Go to parent page">Up</a></td><td class="st300_navbar_next_file_cell"/></tr></table><hr class="st300_hr"/></div><div class="st300_section_container"><a id="smfb"/><div class="st300_section_title_number"><a id="st300_s4" href="#st300_s4" title="Section 4: SMFB - Binary Encoding">4</a></div><div class="st300_section_title">SMFB - Binary Encoding</div><ul class="st300_contents st300_section_contents_outer st300_section_contents"><li class="st300_contents_item st300_contents_item1 st300_contents_item_subsection"><a href="s4.xhtml#st300_s4ss1" title="Link to subsection 4.1: Header">4.1. Header</a></li><li class="st300_contents_item st300_contents_item1 st300_contents_item_subsection"><a href="s4.xhtml#st300_s4ss2" title="Link to subsection 4.2: Data">4.2. Data</a></li></ul><div class="st300_subsection_container"><a id="smfb.header"/><div class="st300_subsection_title_number"><a id="st300_s4ss1" href="#st300_s4ss1" title="Subsection 4.1: Header">4.1</a></div><div class="st300_subsection_title">Header</div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_s4ss1c1" href="#st300_s4ss1c1" title="Paragraph 4.1.1">1</a></div><div class="st300_paragraph">The <span class="st300_term type">SMFB</span> format is a binary encoding for the <a class="st300_link" href="s2.xhtml#smf_model.model">SMF model</a>. The format is separated into a <a class="st300_link" href="s4.xhtml#smfb.header.initial">header</a> and <a class="st300_link" href="s4.xhtml#smfb.data.initial">data</a> section.</div></div><div class="st300_paragraph_container"><a id="smfb.header.initial"/><div class="st300_paragraph_number"><a id="st300_s4ss1c2" href="#st300_s4ss1c2" title="Paragraph 4.1.2">2</a></div><div class="st300_paragraph">All SMFB files begin with a fixed header. The start of the header uses a fixed magic number and a major/minor version number pair indicating the major and minor versions of the specification that defines the file structure.</div></div><div class="st300_formal_item"><a id="smfb.header.start"/><div class="st300_formal_item_title"><a id="st300_s4ss1c3" href="#st300_s4ss1c3" title="Formal item 4.1.3: Header (Start)">4.1.3 Header (Start)</a></div><div class="st300_formal_item_content"><pre class="st300_verbatim">[record SMFBHeaderStart
  ([field magic           [integer unsigned 64]]
   [field version_major   [integer unsigned 32]]
   [field version_minor   [integer unsigned 32]])]

</pre></div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_s4ss1c4" href="#st300_s4ss1c4" title="Paragraph 4.1.4">4</a></div><div class="st300_paragraph">The magic number MUST always be <span class="st300_term constant">0x89534d460d0a1a0a</span>; implementations are required to immediately reject any files that do not begin with this magic number. The derivation of this constant is taken almost verbatim from the PNG <span class="st300_footnote_reference">[<a href="s4.xhtml#st300_f_2365_0" id="st300_fr_2354" title="Jump to footnote smfb.header.footnotes.png (reference 0)">2</a>]</span> file format with the characters PNG changed to SMF .</div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_s4ss1c5" href="#st300_s4ss1c5" title="Paragraph 4.1.5">5</a></div><div class="st300_paragraph">The rest of the header is given by the <span class="st300_term type">SMFBV1Header</span> type:</div></div><div class="st300_formal_item"><a id="smfb.header.main.formal"/><div class="st300_formal_item_title"><a id="st300_s4ss1c6" href="#st300_s4ss1c6" title="Formal item 4.1.6: Header (Main)">4.1.6 Header (Main)</a></div><div class="st300_formal_item_content"><pre class="st300_verbatim">[record SMFBV1Header
  ([field schema                   SMFBV1SchemaID]
   [field vertex_count             [integer unsigned 64]]
   [field triangle_count           [integer unsigned 64]]
   [field triangle_index_size_bits [integer unsigned 32]]
   [field coordinate_system        SMFBV1CoordinateSystems]
   [padding-octets 2]
   [padding-octets 4]
   [field meta_count               [integer unsigned 32]]
   [field attribute_count          [integer unsigned 64]])]

</pre></div></div><div class="st300_paragraph_container"><a id="smfb.header.schema_id"/><div class="st300_paragraph_number"><a id="st300_s4ss1c7" href="#st300_s4ss1c7" title="Paragraph 4.1.7">7</a></div><div class="st300_paragraph">The <span class="st300_term type">SMFBV1SchemaID</span> type encodes the <a class="st300_link" href="s2.xhtml#smf_model.schema_id">schema ID</a>:</div></div><div class="st300_formal_item"><a id="smfb.header.schema_id.formal"/><div class="st300_formal_item_title"><a id="st300_s4ss1c8" href="#st300_s4ss1c8" title="Formal item 4.1.8: Header (schema ID)">4.1.8 Header (schema ID)</a></div><div class="st300_formal_item_content"><pre class="st300_verbatim">[record SMFBV1SchemaID
  ([field vendor_id            [integer unsigned 32]]
   [field schema_id            [integer unsigned 32]]
   [field schema_version_major [integer unsigned 32]]
   [field schema_version_minor [integer unsigned 32]])]

</pre></div></div><div class="st300_paragraph_container"><a id="smfb.header.coords"/><div class="st300_paragraph_number"><a id="st300_s4ss1c9" href="#st300_s4ss1c9" title="Paragraph 4.1.9">9</a></div><div class="st300_paragraph">The <span class="st300_term type">SMFBV1CoordinateSystems</span> type encodes the <a class="st300_link" href="s2.xhtml#smf_model.coords">coordinate system</a>:</div></div><div class="st300_formal_item"><a id="smfb.header.coords.formal"/><div class="st300_formal_item_title"><a id="st300_s4ss1c10" href="#st300_s4ss1c10" title="Formal item 4.1.10: Header (Coordinate system)">4.1.10 Header (Coordinate system)</a></div><div class="st300_formal_item_content"><pre class="st300_verbatim">[packed SMFBV1CoordinateSystems
  ([field right   [integer unsigned 3]]
   [field up      [integer unsigned 3]]
   [field forward [integer unsigned 3]]
   [field winding [integer unsigned 2]]
   [padding-bits 5])]

</pre></div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_s4ss1c11" href="#st300_s4ss1c11" title="Paragraph 4.1.11">11</a></div><div class="st300_paragraph">The <span class="st300_term term">axis</span> and <span class="st300_term term">winding order</span> values are related to integers in the binary encoding via the following functions:</div></div><div class="st300_formal_item"><a id="smfb.header.coords.map_formal"/><div class="st300_formal_item_title"><a id="st300_s4ss1c12" href="#st300_s4ss1c12" title="Formal item 4.1.12: Header (Coordinate system mapping)">4.1.12 Header (Coordinate system mapping)</a></div><div class="st300_formal_item_content"><pre class="st300_verbatim">import qualified Axis as A

axisOrdinal :: A.Axis -&gt; Integer
axisOrdinal A.PositiveX = 0
axisOrdinal A.PositiveY = 1
axisOrdinal A.PositiveZ = 2
axisOrdinal A.NegativeX = 3
axisOrdinal A.NegativeY = 4
axisOrdinal A.NegativeZ = 5

windingOrdinal :: A.WindingOrder -&gt; Integer
windingOrdinal A.WindingOrderClockwise        = 0
windingOrdinal A.WindingOrderCounterClockwise = 1
</pre></div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_s4ss1c13" href="#st300_s4ss1c13" title="Paragraph 4.1.13">13</a></div><div class="st300_paragraph">The header specifies the number of <a class="st300_link" href="s2.xhtml#smf_model.vertex">vertices</a> present in the file, the number of <a class="st300_link" href="s2.xhtml#smf_model.triangle">triangles</a> present in the file, the size in bits of the individual triangle indices, and the number of <a class="st300_link" href="s2.xhtml#smf_model.attribute">attributes</a> present in the file.</div></div><div class="st300_paragraph_container"><a id="smfb.header.attributes"/><div class="st300_paragraph_number"><a id="st300_s4ss1c14" href="#st300_s4ss1c14" title="Paragraph 4.1.14">14</a></div><div class="st300_paragraph">The header concludes by giving definitions for exactly <span class="st300_term variable">n</span> attributes, where <span class="st300_term variable">n</span> is the attribute count specified in the previous section of the header.</div></div><div class="st300_formal_item"><a id="smfb.header.attributes.formal"/><div class="st300_formal_item_title"><a id="st300_s4ss1c15" href="#st300_s4ss1c15" title="Formal item 4.1.15: Header (Attributes)">4.1.15 Header (Attributes)</a></div><div class="st300_formal_item_content"><pre class="st300_verbatim">[record SMFBV1Attribute
  ([field name            [string 64 "UTF-8"]]
   [field component_kind  [integer unsigned 32]]
   [field component_count [integer unsigned 32]]
   [field component_size  [integer unsigned 32]])]

</pre></div></div><div class="st300_paragraph_container"><a id="smfb.header.alignment"/><div class="st300_paragraph_number"><a id="st300_s4ss1c16" href="#st300_s4ss1c16" title="Paragraph 4.1.16">16</a></div><div class="st300_paragraph">The header is constructed with no implicit padding and no particular alignment. However, the individual header structures are constructed such that their sizes are always a multiple of <span class="st300_term constant">8</span>. This ensures that the <a class="st300_link" href="s4.xhtml#smfb.data.initial">data</a> that immediately follows the header also starts on an <span class="st300_term constant">8</span> octet boundary.</div></div></div><div class="st300_subsection_container"><a id="smfb.data"/><div class="st300_subsection_title_number"><a id="st300_s4ss2" href="#st300_s4ss2" title="Subsection 4.2: Data">4.2</a></div><div class="st300_subsection_title">Data</div><div class="st300_paragraph_container"><a id="smfb.data.initial"/><div class="st300_paragraph_number"><a id="st300_s4ss2c1" href="#st300_s4ss2c1" title="Paragraph 4.2.1">1</a></div><div class="st300_paragraph">After the <a class="st300_link" href="s4.xhtml#smfb.header.initial">header</a>, the data for each <a class="st300_link" href="s2.xhtml#smf_model.attribute">attribute</a> is given in full in the order in which the attributes were declared in the header. Specifically, in a file containing <span class="st300_term variable">v</span> vertices and a list of <span class="st300_term variable">n</span> attributes <span class="st300_term variable">a</span>, the file will contain <span class="st300_term variable">v</span> values of the type specified in <span class="st300_term variable">a !! 0</span>, followed by <span class="st300_term variable">v</span> values of the type specified by <span class="st300_term variable">a !! 1</span>, and so on up to <span class="st300_term variable">a !! n - 1</span>.</div></div><div class="st300_paragraph_container"><a id="smfb.data.alignment"/><div class="st300_paragraph_number"><a id="st300_s4ss2c2" href="#st300_s4ss2c2" title="Paragraph 4.2.2">2</a></div><div class="st300_paragraph">The start of the data for each attribute is aligned to the next <span class="st300_term constant">8</span> octet boundary regardless of type. The alignment is achieved by inserting padding octets at the end of the previous attribute. For example, the following diagram shows how the data is aligned for a file containing three vertices with two attributes <span class="st300_term variable">A</span> and <span class="st300_term variable">B</span>. Attribute <span class="st300_term variable">A</span> consists of three 16-bit floating-point components, and attribute <span class="st300_term variable">B</span> consists of three 32-bit floating-point components. As the file has three vertices, <span class="st300_term variable">3 * 3 = 9</span> values are placed into the file first, consuming <span class="st300_term variable">3 * 3 * 2 = 18</span> octets. Because the next octet, <span class="st300_term variable">18</span>, is not divisible by <span class="st300_term variable">8</span>, it's necessary to insert <span class="st300_term variable">6</span> octets of padding so that the data for <span class="st300_term variable">B</span> will start on the next <span class="st300_term variable">8</span> octet boundary.</div></div><div class="st300_formal_item"><a id="smfb.data.padding"/><div class="st300_formal_item_title"><a id="st300_s4ss2c3" href="#st300_s4ss2c3" title="Formal item 4.2.3: Padding">4.2.3 Padding</a></div><div class="st300_formal_item_content"><img class="st300_image" alt="Padding for alignment" src="alignment.svg.png"/></div></div><div class="st300_paragraph_container"><a id="smfb.data.endianness"/><div class="st300_paragraph_number"><a id="st300_s4ss2c4" href="#st300_s4ss2c4" title="Paragraph 4.2.4">4</a></div><div class="st300_paragraph">All values are stored in big-endian form.</div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_s4ss2c5" href="#st300_s4ss2c5" title="Paragraph 4.2.5">5</a></div><div class="st300_paragraph">After all triangle and attribute data has been specified, the <a class="st300_link" href="s2.xhtml#smf_model.metadata">metadata</a> values are specified. A metadata value begins with the following structure:</div></div><div class="st300_formal_item"><a id="smfb.data.metadata"/><div class="st300_formal_item_title"><a id="st300_s4ss2c6" href="#st300_s4ss2c6" title="Formal item 4.2.6: Metadata">4.2.6 Metadata</a></div><div class="st300_formal_item_content"><pre class="st300_verbatim">[record SMFBV1Metadata
  ([field vendor [integer unsigned 32]]
   [field schema [integer unsigned 32]]
   [field size   [integer unsigned 64]])]</pre></div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_s4ss2c7" href="#st300_s4ss2c7" title="Paragraph 4.2.7">7</a></div><div class="st300_paragraph">The <span class="st300_term variable">vendor</span> and <span class="st300_term variable">schema</span> fields are for use by applications to identify the types of metadata. The <span class="st300_term variable">size</span> field records the size of the metadata in octets.</div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_s4ss2c8" href="#st300_s4ss2c8" title="Paragraph 4.2.8">8</a></div><div class="st300_paragraph">This structure is followed by the opaque metadata octets with any additional <a class="st300_link" href="s4.xhtml#smfb.data.alignment">padding</a> to ensure that the next metadata value occurs on an 8 octet boundary. The padding is not included in the recorded size of the metadata.</div></div></div><div class="st300_footnotes"><hr/><div class="st300_footnote_container"><div class="st300_footnote_id">[<a id="st300_f_2365_0" href="s4.xhtml#st300_fr_2354" title="Jump back to reference 0 of footnote smfb.header.footnotes.png">2</a>]</div><div class="st300_footnote_body"><a class="st300_link_external" href="https://en.wikipedia.org/wiki/Portable_Network_Graphics#File_header">https://en.wikipedia.org/wiki/Portable_Network_Graphics#File_header</a></div></div></div></div><div class="st300_navbar st300_navbar_bottom"><hr class="st300_hr"/><table class="st300_navbar_table" summary="st300_Navigation bar"><tr><td class="st300_navbar_prev_file_cell"><a rel="previous" href="s3.xhtml#st300_s3" title="Go to previous page">Previous</a></td><td class="st300_navbar_up_file_cell"><a rel="up" href="index-m.xhtml" title="Go to parent page">Up</a></td><td class="st300_navbar_next_file_cell"/></tr><tr><td class="st300_navbar_prev_title_cell">3. SMFT - Text Encoding</td><td class="st300_navbar_up_title_cell">io7m-smfj 0.9.0 Specification</td><td class="st300_navbar_next_title_cell"/></tr></table></div></div></body></html>
